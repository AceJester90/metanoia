<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/ERC1155 Redeemer.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> ERC1155 Redeemer.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/16</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/12</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/4</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/16</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">//SPDX-License-Identifier: MIT
&nbsp;
pragma solidity 0.8.4;
&nbsp;
import "@openzeppelin/contracts/token/ERC1155/utils/ERC1155Holder.sol";
import "@openzeppelin/contracts/token/ERC1155/IERC1155.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
&nbsp;
interface ITypedNftSender {
    function getNftType(uint nftId) external view returns (uint);
}
&nbsp;
contract ERC1155Redeemer is ERC1155Holder, Ownable {
&nbsp;
    mapping (address =&gt; mapping (uint =&gt; uint)) public selfBalances;
    mapping (address =&gt; bool) whitelist; //not implemented yet 
&nbsp;
    /* 
    contractAddress refers to this contract,
     */
    event ERC1155Received (
        uint indexed date,
        address indexed from,
        uint indexed nftId,
        address contractAddress, 
        address nftContractAddress,
        uint nftType
    );
&nbsp;
    /*  WARNING: The current implementation of this allows anyone to call the function 
        regardless of whether they have actually sent the ERC1155 to this contract.
        This MUST be fixed before production.
&nbsp;
        This has been fixed by tracking this contract's address internally and 
        checking it against this contract's balance from the sending contract.
        This needs to be tested before this message can be removed.
    */
<span class="fstat-no" title="function not covered" >    function onERC1155Received(</span>
        address /*operator*/,
        address from,
        uint256 nftId,
        uint256 value,
        bytes memory
    ) public virtual override returns (bytes4) {
<span class="cstat-no" title="statement not covered" >        require(value == 1, "Please redeem only one NFT at a time")</span>;
<span class="cstat-no" title="statement not covered" >        require(</span>
            IERC1155(msg.sender).balanceOf(address(this), nftId) 
            == selfBalances[msg.sender][nftId] + 1,
            "Redeemer contract's balance of this nft is not the expected value"
        );
<span class="cstat-no" title="statement not covered" >        try ITypedNftSender(msg.sender).getNftType(nftId) returns (uint) {</span>
<span class="cstat-no" title="statement not covered" >            require(</span>
                ITypedNftSender(msg.sender).getNftType(nftId) &gt;= 0, 
                "Nft Minter contract provides invalid nftType"
            );
<span class="cstat-no" title="statement not covered" >            require(</span>
                ITypedNftSender(msg.sender).getNftType(nftId) != 3, 
                "Cannot redeem NFT type 3 (infinite-use) via this contract."
            );
        } catch {
<span class="cstat-no" title="statement not covered" >            revert("Nft Minter contract does not provide getNftType external function")</span>;
        }
<span class="cstat-no" title="statement not covered" >        uint nftType = ITypedNftSender(msg.sender).getNftType(nftId);</span>
<span class="cstat-no" title="statement not covered" >        selfBalances[msg.sender][nftId] += 1</span>;
<span class="cstat-no" title="statement not covered" >        emit ERC1155Received(block.timestamp, from, nftId, address(this), msg.sender, nftType);</span>
<span class="cstat-no" title="statement not covered" >        return this.onERC1155Received.selector;</span>
    }
&nbsp;
    // needs testing to make sure it fails successfully
<span class="fstat-no" title="function not covered" >    function onERC1155BatchReceived(</span>
        address /*operator*/,
        address /*from*/,
        uint256[] memory /*nftIds*/,
        uint256[] memory /*values*/,
        bytes memory
    ) public virtual override returns (bytes4) {
<span class="cstat-no" title="statement not covered" >        revert("Please redeem only one NFT at a time to this redeemer contract")</span>;
    }
&nbsp;
    // TO DO: upgrade the error messages to show the relevant values
    // TO DO: test this function
<span class="fstat-no" title="function not covered" >    function returnERC1155(address to, address nftContract, uint nftId) public onlyOwner {</span>
<span class="cstat-no" title="statement not covered" >        require(</span>
            IERC1155(nftContract).balanceOf(address(this), nftId) 
            == selfBalances[nftContract][nftId],
            "Redeemer contract's balance of this nft with this id is not the expected value"
        );
<span class="cstat-no" title="statement not covered" >        require(selfBalances[nftContract][nftId] &gt;= 1,</span>
            "Redeemer contract's balance of this nft with this id is zero"
        );
<span class="cstat-no" title="statement not covered" >        IERC1155(nftContract).safeTransferFrom(address(this), to, nftId, 1, "")</span>;
<span class="cstat-no" title="statement not covered" >        selfBalances[nftContract][nftId] -= 1</span>;
    }
&nbsp;
    // needs testing
<span class="fstat-no" title="function not covered" >    function checkThisContractsBalance(address nftContract, uint nftId) </span>
    public view returns (uint) {
<span class="cstat-no" title="statement not covered" >        return IERC1155(nftContract).balanceOf(address(this), nftId);</span>
    }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Jul 18 2022 13:03:50 GMT-0700 (Pacific Daylight Saving Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
